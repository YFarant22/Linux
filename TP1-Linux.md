# TP1-Linux
## 0.Préparation de la machine
**Setup des deux machine**
(Exemple pour une machine, répété sur l'autre)

- Un accès internet (via carte lan):
```
[Y@localhost ~]$ ip a
[...]
2: enp0s3: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 08:00:27:67:26:dc brd ff:ff:ff:ff:ff:ff
    inet 10.0.2.15/24 brd 10.0.2.255 scope global dynamic noprefixroute enp0s3
       valid_lft 85996sec preferred_lft 85996sec
    inet6 fe80::a00:27ff:fe67:26dc/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
[...]
```

- Un accès à un réseau local:
```
[Y@localhost ~]$ ip a
[...]
3: enp0s8: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 08:00:27:8e:8d:b3 brd ff:ff:ff:ff:ff:ff
    inet 10.101.1.11/24 brd 10.101.1.255 scope global noprefixroute enp0s8
       valid_lft forever preferred_lft forever
    inet6 fe80::a00:27ff:fe8e:8db3/64 scope link
       valid_lft forever preferred_lft forever
```

- Vous n'utilisez QUE ssh pour administrer les machines:
-> (Sur windows)
```
C:\Users\yanno>ssh Y@10.101.1.11
The authenticity of host '10.101.1.11 (10.101.1.11)' can't be established.
ECDSA key fingerprint is SHA256:+4EemQD1zSB64N0IOoON1TPHt0bL1uSsdnnZ01uLOfs.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '10.101.1.11' (ECDSA) to the list of known hosts.
Y@10.101.1.11's password:
Last login: Tue Sep 28 22:05:47 2021
```

- Les machines doivent avoir un nom:
```
[Y@localhost ~]$ sudo hostname node1.tp1.b2
[sudo] password for Y:
[Y@localhost ~]$ hostname
node1.tp1.b2
```

- Utiliser 1.1.1.1 comme serveur DNS:
-> Recherche
```
[Y@localhost ~]$ sudo cat /etc/re
redhat-release  resolv.conf
[Y@localhost ~]$ sudo cat /etc/resolv.conf
# Generated by NetworkManager
search home
nameserver 192.168.1.1
```
-> Résolution
```
[Y@localhost ~]$ sudo nano /etc/resolv.conf
[Y@localhost ~]$ [Y@localhost ~]$ sudo cat /etc/resolv.conf
# Generated by NetworkManager
search home
nameserver 1.1.1.1
```

-> Tests
```
[Y@localhost ~]$ dig ynov.com

; <<>> DiG 9.11.26-RedHat-9.11.26-4.el8_4 <<>> ynov.com
[...]
;; ANSWER SECTION:
ynov.com.               4006    IN      A       92.243.16.143
[...]
;; SERVER: 1.1.1.1#53(1.1.1.1)
```

- Les machines doivent pouvoir se joindre par leurs noms respectifs:
-> Recherche
```
[Y@localhost ~]$ sudo cat /etc/hosts
[sudo] password for Y:
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
```
-> Résolution
```
[Y@localhost ~]$ sudo nano /etc/hosts
[sudo] password for Y:
[Y@localhost ~]$ [Y@localhost ~]$ sudo cat /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
10.101.1.11 node1
10.101.1.12 node2
```
-> Tests
```
[Y@localhost ~]$ [Y@localhost ~]$ ping node1
PING node1 (10.101.1.11) 56(84) bytes of data.
64 bytes from node1 (10.101.1.11): icmp_seq=1 ttl=64 time=0.065 ms
64 bytes from node1 (10.101.1.11): icmp_seq=2 ttl=64 time=0.128 ms
64 bytes from node1 (10.101.1.11): icmp_seq=3 ttl=64 time=0.060 ms
64 bytes from node1 (10.101.1.11): icmp_seq=4 ttl=64 time=0.148 ms
^C
--- node1 ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 3081ms
rtt min/avg/max/mdev = 0.060/0.100/0.148/0.039 ms
```
```
[Y@localhost ~]$ ping node2
PING node2 (10.101.1.12) 56(84) bytes of data.
64 bytes from node2 (10.101.1.12): icmp_seq=1 ttl=64 time=1.26 ms
64 bytes from node2 (10.101.1.12): icmp_seq=2 ttl=64 time=1.52 ms
64 bytes from node2 (10.101.1.12): icmp_seq=3 ttl=64 time=1.54 ms
64 bytes from node2 (10.101.1.12): icmp_seq=4 ttl=64 time=1.31 ms
^C
--- node2 ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 3005ms
rtt min/avg/max/mdev = 1.255/1.408/1.543/0.132 ms
```
- Le pare-feu est configuré pour bloquer toutes les connexions exceptées celles qui sont nécessaires:
```
[Y@localhost ~]$ sudo firewall-cmd --list-all
public (active)
  target: default
  icmp-block-inversion: no
  interfaces: enp0s3 enp0s8
  sources:
  services: cockpit dhcpv6-client ssh
  ports:
  protocols:
  masquerade: no
  forward-ports:
  source-ports:
  icmp-blocks:
  rich rules:
```


---

## I. Utilisateurs
1. Création et configuration
 -> Création de l'utilisateur
 ```
[Y@localhost ~]$ sudo useradd Yadmin -m -s /bin/bash
 [Y@localhost ~]$ ls /home
Y  Yadmin
```

-> Création du group "admins"
```
[Y@localhost ~]$ sudo groupadd admins
```
-> Groupe admin ajouté au fichier "/etc/sudoers"
```
[Y@localhost ~]$ sudo visudo
```
Ligne de commande ajouté:
```%admins  ALL=(ALL)       ALL```

-> Ajout de l'utilisateur 
```
[Y@localhost ~]$ sudo usermod -aG admins Yadmin
[Y@localhost ~]$ groups Yadmin
Yadmin : Yadmin admins
```

2. SSH



---

## II. Partitionnement

1. Préparation de la VM

```
[Y@localhost ~]$ sudo lsblk
NAME        MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sda           8:0    0    8G  0 disk
├─sda1        8:1    0    1G  0 part /boot
└─sda2        8:2    0    7G  0 part
  ├─rl-root 253:0    0  6.2G  0 lvm  /
  └─rl-swap 253:1    0  820M  0 lvm  [SWAP]
sdb           8:16   0    3G  0 disk
sdc           8:32   0    3G  0 disk
sr0          11:0    1 1024M  0 rom
```

Disques ajoutés: sdb, sdc.

-> agréger les deux disques en un seul volume group
```
[Y@localhost ~]$ sudo vgcreate sdvg /dev/sdb
  Physical volume "/dev/sdb" successfully created.
  Volume group "sdvg" successfully created
```
```
[Y@localhost ~]$ sudo vgextend sdvg  /dev/sdc
  Physical volume "/dev/sdc" successfully created.
  Volume group "sdvg" successfully extended
```

```
[Y@localhost ~]$ sudo vgs
  VG   #PV #LV #SN Attr   VSize  VFree
  rl     1   2   0 wz--n- <7.00g    0
  sdvg   2   3   0 wz--n-  5.99g 2.99g
```

-> créer 3 logical volumes de 1 Go chacun
```
[Y@localhost ~]$ sudo lvcreate -L 1G sdvg -n t1
  Logical volume "t1" created.
[Y@localhost ~]$ sudo lvcreate -L 1G sdvg -n t2
  Logical volume "t2" created.
[Y@localhost ~]$ sudo lvcreate -L 1G sdvg -n t3
  Logical volume "t3" created.
```
```
[Y@localhost ~]$ sudo lvs
  LV   VG   Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert
  root rl   -wi-ao----  <6.20g
  swap rl   -wi-ao---- 820.00m
  t1   sdvg -wi-ao----   1.00g
  t2   sdvg -wi-ao----   1.00g
  t3   sdvg -wi-ao----   1.00g
```

-> formater ces partitions en ext4
```
[Y@localhost ~]$ sudo mkfs -t ext4 /dev/sdvg/t1
mke2fs 1.45.6 (20-Mar-2020)
Creating filesystem with 262144 4k blocks and 65536 inodes
Filesystem UUID: ebae92f9-41b1-4a95-9129-e7f8d164a701
Superblock backups stored on blocks:
        32768, 98304, 163840, 229376

Allocating group tables: done
Writing inode tables: done
Creating journal (8192 blocks): done
Writing superblocks and filesystem accounting information: done

[Y@localhost ~]$ sudo mkfs -t ext4 /dev/sdvg/t2
mke2fs 1.45.6 (20-Mar-2020)
Creating filesystem with 262144 4k blocks and 65536 inodes
Filesystem UUID: 362abb8b-5b73-491f-8109-70a83d968ab2
Superblock backups stored on blocks:
        32768, 98304, 163840, 229376

Allocating group tables: done
Writing inode tables: done
Creating journal (8192 blocks): done
Writing superblocks and filesystem accounting information: done

[Y@localhost ~]$ sudo mkfs -t ext4 /dev/sdvg/t3
mke2fs 1.45.6 (20-Mar-2020)
Creating filesystem with 262144 4k blocks and 65536 inodes
Filesystem UUID: 9c72b4f0-bf0b-4558-a5d2-76292aab3ade
Superblock backups stored on blocks:
        32768, 98304, 163840, 229376

Allocating group tables: done
Writing inode tables: done
Creating journal (8192 blocks): done
Writing superblocks and filesystem accounting information: done
```

-> Montage des partitions

```
[Y@localhost ~]$ sudo mount /dev/sdvg/t1 /mnt/part1
[Y@localhost ~]$ sudo mount /dev/sdvg/t2 /mnt/part2
[Y@localhost ~]$ sudo mount /dev/sdvg/t3 /mnt/part3
```
```
[Y@localhost ~]$ df -h
[...]
/dev/mapper/sdvg-t1  976M  2.6M  907M   1% /mnt/part1
/dev/mapper/sdvg-t2  976M  2.6M  907M   1% /mnt/part2
/dev/mapper/sdvg-t3  976M  2.6M  907M   1% /mnt/part3
```

-> Montage auto au démarage
```
[Y@localhost ~]$ sudo umount /mnt/part1
[Y@localhost ~]$ sudo umount /mnt/part2
[Y@localhost ~]$ sudo umount /mnt/part3
[Y@localhost ~]$ df -h
Filesystem           Size  Used Avail Use% Mounted on
devtmpfs             890M     0  890M   0% /dev
tmpfs                909M     0  909M   0% /dev/shm
tmpfs                909M  8.6M  901M   1% /run
tmpfs                909M     0  909M   0% /sys/fs/cgroup
/dev/mapper/rl-root  6.2G  1.6G  4.7G  26% /
/dev/sda1           1014M  199M  816M  20% /boot
tmpfs                182M     0  182M   0% /run/user/1000
[Y@localhost ~]$ sudo mount -av
[...]
/mnt/part1               : successfully mounted
[...]
/mnt/part2               : successfully mounted
[...]
/mnt/part3               : successfully mounted
```


---

## III. Gestion de services
1. Interaction avec un service existant
```
[Y@localhost ~]$ systemctl is-active firewalld
active
[Y@localhost ~]$ systemctl is-enabled firewalld
enabled
```

2. Création de service
- A. Unité simpliste
-> Création du fichier
```
[Y@localhost ~]$ sudo nano /etc/systemd/system/web.service
[Y@localhost ~]$ sudo cat /etc/systemd/system/web.service
[Unit]
Description=Very simple web service

[Service]
ExecStart=/bin/python3 -m http.server 8888

[Install]
WantedBy=multi-user.target
[Y@localhost ~]$ sudo systemctl daemon-reload
```
-> relecture des fichiers + Interaction avec l'unité
```
[Y@localhost ~]$ sudo systemctl start web
[Y@localhost ~]$ sudo systemctl enable web
Created symlink /etc/systemd/system/multi-user.target.wants/web.service → /etc/systemd/system/web.service.
[Y@localhost ~]$ sudo systemctl status web
● web.service - Very simple web service
   Loaded: loaded (/etc/systemd/system/web.service; enabled; vendor preset: disable>
   Active: active (running) since Wed 2021-09-29 21:52:07 EDT; 8s ago
[...]
```

-> Test avec la commande "curl" sur la VM
```
[Y@localhost ~]$ curl 10.101.1.11:8888
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
[...]
```
- B. Modification de l'unité
-> Création de l'utilisateur "web"
```
[Y@localhost ~]$ [Y@localhost ~]$ sudo useradd web
[sudo] password for Y:
```

-> Modification du ficher "web.service"
```
[Y@localhost ~]$ sudo nano /etc/systemd/system/web.service
[Y@localhost ~]$ sudo cat /etc/systemd/system/web.service
[Unit]
Description=Very simple web service

[Service]
ExecStart=/bin/python3 -m http.server 8888
User=web
WorkingDirectory=/srv/web_directory

[Install]
WantedBy=multi-user.target
```

-> Mise en place des permissions sur le fichier
```
[Y@localhost ~]$ sudo chown web /srv/web_directory/test
```